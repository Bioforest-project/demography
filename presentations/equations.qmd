---
title: "WG3 - Equations"
format:
  html:
    code-fold: true
editor: visual
---

```{r}
#| message: false
#| warning: false
library(DiagrammeR)
library(tidyverse)
```

```{r}
data_path <- "D:/github/Bioforest-project/inventories/data"
data <- read.csv(paste0(data_path, "/derived_data/aggregated_data.csv"))

control_string <- "unlogged|to be logged|old-growth|control|natural"
silv_string <- "treatment|devital|thinning"

plot_info <- 
  read.csv(paste0(data_path, "/raw_data/bioforest-plot-information.csv")) |>
  mutate(site = ifelse(site == "BAFOG", "Bafog", site)) |>
  mutate(site = ifelse(site == "Montagne_tortue", "Montagne_Tortue", site)) |>
  # harmonize treatment information as logging and silvicultural treatments
  mutate(
    Treatment = ifelse(Treatment != "", Treatment, NA),
    logging = !grepl(control_string, tolower(Treatment)),
    silv_treat = grepl(silv_string, tolower(Treatment)), 
    year_log = ifelse(site == "Paracou", 1986, 
                      Year_of_harvest |> substr(1,4) |> as.numeric()
    )
  ) |>
  select(site, plot, logging, silv_treat, year_log)
```

# Previous decisions

## Diagram from workshop 3 - revisited

```{r}
grViz("
digraph {

  rankdir=LR

  graph [overlap = true, fontsize = 10]

  subgraph cluster_ba{
    label='Basal area'; fontsize = 14;
    node [shape = box, fillcolor='coral', style=filled, fontsize=12]
    ba_stock [label='Stock']
    ba_in [label='Gain']
    ba_out [label='Loss']
  }
  
  node [shape = box, fillcolor='coral', style=filled]
  {rank=same
  cwm [label='Functional\ncomposition']
  div [label='Functional\ndiversity']
  }
  node [fillcolor='powderblue']
  env [label='Environmental\nvariables']
  intensity [label='Logging\nintensity']
  
  node [shape = ellipse, fillcolor='whitesmoke'] 
  {rank=same
  closure[label='Canopy\nclosure']
  vmax[label='Asymptotic\nparameters*']
  }
  
  intensity -> closure
  closure -> {ba_in cwm}
  vmax -> {ba_out ba_in cwm div}
  env -> {closure vmax}
  cwm -> {ba_in ba_out div}
  ba_stock -> closure
  
  edge [style = bold]
  div -> ba_in
  
  edge [style = dashed]
  ba_in -> ba_stock
  ba_out -> ba_stock
  
  node [shape = plaintext, fillcolor='white']
  legend[label='*Asymptotic stocks: carrying capacity\nor fluxes: equilibrium turnover rate']
}
")
```

## Integrating fluxes and stocks

-   use recovery model for fluxes, with same asymptotic value

-   integrate fluxes to estimate stocks $\rightarrow$ decrease the number of parameters, explicit link between sotck sand fluxes

$$\frac{d (stocks(t))}{dt} = prod(t) - mort(t)$$

$$ stocks(t) = stocks(t_0) + \int_{t_0}^{t} \left(prod - mort \right) $$

**Advantages**: limited number of parameters, explicit link between stocks and fluxes

Constraint: $lim_{\infty}(prod) = lim_{\infty}(mort)$

# Defining functions

## Productivity

For productivity we can use the general recovery model:

$$ prod = \theta_0 + (\theta_{\infty} -\theta_0)\cdot(STP+LTP)$$

$$LTP = 1 - exp(-\lambda\cdot t) $$ 

$$STP = \delta \cdot \left(\frac{t}{\tau} \cdot exp\left(1 - \frac{t}{\tau}\right)\right)^2 $$

```{r}
#| message: false
#| warning: false
data |> 
  merge(plot_info, by.x = c("Site", "Plot"), by.y = c("site", "plot")) |>
  subset(variable %in% c("ba_growth", "ba_recr")) |> 
  subset(Site %in% c("Mbaiki", "Paracou", "Ulu Muda", "Misiones")) |>
  pivot_wider(names_from = "variable") |>
  ggplot(aes(Year, ba_recr+ba_growth, col = logging, group = Plot)) +
  geom_point() +
  geom_line() +
  facet_wrap(~Site, scales = "free") +
  theme_minimal()
```

## Mortality

Due to its high stochasticity, it is challenging to identify any general trend in mortality. To avoid overcomplicating the model, two simple assumptions can be considered:

i. the absolute mortality remains constant over time;

ii. the mortality rate (mortality/stocks) remains constant over time.

The second hypothesis has the advantage of being more robust to limit conditions (e.g. when the stocks tend towards zero, the absolute mortality cannot be higher than the stocks).

```{r}
#| message: false
#| warning: false
data |> 
  merge(plot_info, by.x = c("Site", "Plot"), by.y = c("site", "plot")) |> 
  subset(variable %in% c("ba_mort", "ba")) |> 
  subset(Site %in% c("Mbaiki", "Paracou", "Ulu Muda", "Misiones")) |>
  subset((Year > year_log +5 & !is.na(year_log)) | !logging) |> 
  pivot_wider(names_from = "variable") |> 
  arrange(Year) |> 
  ggplot(aes(ba, ba_mort)) +
  geom_point(aes(col = logging, group = Plot)) +
  geom_path(aes(col = logging, group = Plot)) +
  geom_smooth() +
  scale_x_log10() + scale_y_log10() +
  facet_wrap(~Site, scales = "free") +
  theme_minimal() 
```

```{r}
#| message: false
#| warning: false
data |> 
  merge(plot_info, by.x = c("Site", "Plot"), by.y = c("site", "plot")) |> 
  subset(variable %in% c("ba_mort", "ba")) |> 
  subset(Site %in% c("Mbaiki", "Paracou", "Ulu Muda", "Misiones")) |>
  subset((Year > year_log +5 & !is.na(year_log)) | !logging) |> 
  pivot_wider(names_from = "variable") |> 
  arrange(Year) |> 
  ggplot(aes(Year, ba_mort/ba)) +
  geom_point(aes(col = logging, group = Plot)) +
  geom_path(aes(col = logging, group = Plot)) +
  labs(y = "Relative mortality = BAmort/BA") +
  # geom_smooth() +
  scale_x_log10() + scale_y_log10() +
  facet_wrap(~Site, scales = "free") +
  theme_minimal() 
```
There doesn't seem to be a strong correlation between BA mortality and BA in our data, but as a first approximation considering that mortality is proportional to basal area might work.

## Stocks

$$ba'(t) = prod(t)-mort(t)$$ 

$$ba(t) = ba(0) + \int_{0}^{t} \left(prod(t)-mort(t)\right)dt $$

# Writing BA as a function of productivity and mortality

## Under assumption of constant mortality

Here we define productivity with the general recovery model, and we hypothesize that mortality is a constant: 

$$ prod(t) = \theta_0 + (\theta_{\infty} -\theta_0)\cdot\left(1 - exp(-\lambda\cdot t)+\delta \cdot \left(\frac{t}{\tau} \cdot exp\left(1 - \frac{t}{\tau}\right)\right)^2\right)$$

$$ba'(t) = prod(t) - k$$
We need $lim_{\infty}(prod) = lim_{\infty}(mort)$ to have a stable asymptotic basal area. We therefore have: 

$k = \theta_{\infty}$

We can therefore write : 

$$ba(t) =  ba(0) + \int_{t=0}^{\infty}prod(x) dx - \theta_{\infty}$$ 

After integrating the productivity equation (see Appendix "Integration of STP" for the integration ), we get the following equation for basal area: 
$$ba(t) = ba(0) + (\theta_{\infty} - \theta_0)\left(\frac{\delta \cdot e^{2} \cdot\tau}{4} - \delta \cdot e^{(1-\frac{t}{\tau})2} \left(\frac{t^2}{2\tau}+\frac{t}{2}+\frac{\tau}{4}\right) - \frac{1}{\lambda} (1-e^{-\lambda\cdot t})\right) $$

The figure below illustrates the resulting stocks and fluxes with parameters set to: 

- $\tau = 10$
- $\lambda = 0.05$
- $\delta = 1$
- $\theta_{\infty} = 0.5$
- $\theta_0 = 0.4$
- $ba_0 = 10$

```{r, fig.width = 6, fig.height = 6}
thetainf = 0.5
theta0 = 0.4
ba0 = 10
lambda = 0.05

ltp = function(x, lambda = 0.05) 1-exp(-lambda*x)
stp = function(time, delta = 1, tau = 10) {
  delta * (time / tau * exp(1 - time / tau))^2
}
int_stp = function(time, delta = 1, tau = 10) {
  delta*exp(2)*tau/4 - delta * exp((1-time/tau)*2) * (time^2/(2*tau)+time/2+tau/4)
}

facet_labs <- c("ba" = "Basal area [m2/ha]", 
                "prod" = "Productivity [m2/ha/yr]", 
                "mort" = "Mortality [m2/ha/yr]")

data.frame(t = seq(0, 100, length.out = 200)) |> 
  mutate(prod = theta0 + (thetainf-theta0)*(stp(t)+ltp(t)), 
         mort = thetainf,
         ba = ba0 + (thetainf-theta0)*(int_stp(t) - 1/lambda*(1-exp(-lambda*t)))
  ) |>   
  pivot_longer(-t) |>
  ggplot(aes(t, value)) + 
  geom_line() + 
  facet_wrap(~name, scales = "free", nrow = 3, 
             labeller = labeller(name = facet_labs), 
             strip.position="left") +
  labs(x = "Recovery time [yr]", y = NULL) +
  theme_minimal() + theme(strip.placement = "outside")
```

## Under assumption of proportional mortality

Here we define productivity with the general recovery model, and we hypothesize that mortality is proportional to basal area: 

$$ prod(t) = \theta_0 + (\theta_{\infty} -\theta_0)\cdot\left(1 - exp(-\lambda\cdot t)+\delta \cdot \left(\frac{t}{\tau} \cdot exp\left(1 - \frac{t}{\tau}\right)\right)^2\right)$$

$$ba'(t) = prod(t) - \omega \cdot ba(t)$$
and the initial condition: 

$ba(t=0) = BA_0$ 

The solution to this equation is:

$$ba(t) = \frac{\theta_{\infty}}{\omega} + Kexp(-\omega t) + \frac{\lambda(\theta_{\infty}-\theta_0) }{1-\omega\lambda} \cdot exp(-\lambda\cdot t) + exp(1-\frac{t}{\tau})^2\frac{2\delta(\theta_{\infty}-\theta_0)}{\tau^2(2\omega-\tau)}\left(t^2 - t\frac{4}{(2\omega-\tau)} + \frac{8}{(2\omega-\tau)^2}\right)$$

with:

$$ K = ba_0 - \frac{\theta_{\infty}}{\omega} - \frac{\lambda(\theta_{\infty}-\theta_0) }{1-\omega\lambda} -\frac{16e^2\delta(\theta_{\infty}-\theta_0)}{\tau^2(2\omega-\tau)^3}$$
(see Appendix "Differential equation")

```{r}
ba <- function(x,
               tau = 10,
               lambda = 0.05,
               delta = 1,
               thetainf = 0.5,
               theta0 = 0.4,
               omega = 0.02,
               ba0 = 10) {
  k = ba0 - thetainf / omega - ((theta0 - thetainf) * lambda) / (omega * lambda - 1) -
    (16 * exp(2) * delta * (thetainf - theta0)) / (tau^2 * (2 * omega - tau)^3)
  return(
    thetainf / omega + k * exp(-omega * x) + ((theta0 - thetainf) * lambda) / (omega * lambda - 1) * exp(-lambda * x) + (exp(1 - x / tau))^2 * (2 * delta * (thetainf - theta0)) / (tau^2 * (2 * omega - tau)) * (x^2 - x * 4 / (2 * omega - tau) + 8 / (2 * omega - tau)^2)
  )
}
prod = function(x,
                tau = 10,
                lambda = 0.05,
                delta = 1,
                thetainf = 0.5,
                theta0 = 0.4
) {
  return(theta0 + (thetainf-theta0)*((1-exp(-lambda*x)) + delta*((x/tau)*exp(1-x/tau))^2))
}
mort <- function(x,
                 tau = 10,
                 lambda = 0.05,
                 delta = 1,
                 thetainf = 0.5,
                 theta0 = 0.4,
                 omega = 0.02,
                 ba0 = 10
) {
  return(omega * ba(x, tau, lambda, delta, thetainf, theta0, omega, ba0))
}
```

Below is a graph of the resulting fluxes and stocks with parameter values: 

- $\tau = 10$
- $\lambda = 0.05$
- $\delta = 1$
- $\theta_{\infty} = 0.5$
- $\theta_0 = 0.4$
- $\omega = 0.02$
- $ba_0 = 10$

```{r, fig.width = 6, fig.height = 6}
facet_labs <- c("ba" = "Basal area [m2/ha]", 
                "prod" = "Productivity [m2/ha/yr]", 
                "mort" = "Mortality [m2/ha/yr]")

data.frame(t = seq(0, 200, 1e-2)) |> 
  mutate(ba = ba(t, tau = 5), prod = prod(t, tau = 5), mort = mort(t, tau = 5)) |>  
  pivot_longer(-t) |>
  ggplot(aes(t, value)) + 
  geom_line() + 
  scale_x_sqrt() +
  facet_wrap(~name, scales = "free", nrow = 3, 
             labeller = labeller(name = facet_labs), 
             strip.position="left") +
  labs(x = "Recovery time [yr]", y = NULL) +
  theme_minimal() + theme(strip.placement = "outside")
```

To identify which parameters of the model have the strongest effect on the recovery rate of the basal area, we performed a sensitivity analysis by making each parameter vary while others remained constant, and estimated the time (in years) to recover 95% of basal area lost, estimated as the asymptotic basal area (equal to $\frac{\theta_{\infty}}{\omega}$) minus the post-logging basal area $BA_0$.

```{r}
# what parameters have the most effect on the recovery rate of ba? 
pars <- data.frame(
  param = c("tau", "lambda", "delta", "theta[infinity]", 
            "theta[0]", "omega", "ba[0]"), 
  min = c(1, 1e-3, 1e-3, 0.1, 0.1, 0.001, 1e-3), 
  max = c(50, 1, 10, 1, 1, 0.2, 20)
)

get_t95 <- function(tau, lambda, delta, thetainf, theta0, omega, ba0) {
  min(which(
    ba(1:1e4, tau, lambda, delta, thetainf, theta0, omega, ba0) > 0.95 * (thetainf / omega - ba0) + ba0
  ))
}
pars |> 
  group_by(param) |> 
  reframe(value = exp(seq(log(min), log(max), length.out = 10))) |> 
  cbind(data.frame(
    tau = 10, lambda = 0.05, delta = 1, theta_inf = 0.5,
    theta_0 = 0.4, omega = 0.02, ba_0 = 10)) |> 
  mutate(tau = ifelse(param == "tau", value, tau), , 
         lambda = ifelse(param == "lambda", value, lambda), 
         delta = ifelse(param == "delta", value, delta), 
         thetainf = ifelse(param == "theta[infinity]", value, thetainf),
         theta0 = ifelse(param == "theta[0]", value, theta0),
         omega = ifelse(param == "omega", value, omega),
         ba0 = ifelse(param == "ba[0]", value, ba0)) |> 
  # constraints: theta0 < thetainf and ba0 < bainf = thetainf/omega
  subset(theta0<thetainf &  ba0 < thetainf/omega) |> 
  rowwise() |>
  mutate(t95 = get_t95(tau, lambda, delta, thetainf, theta0, omega, ba0)) |> 
  ggplot(aes(value, t95)) +
  geom_line() +
  scale_x_log10() + scale_y_log10() +
  facet_wrap(~param, scales = "free", 
             labeller = label_parsed, 
             strip.position="bottom") +
  labs(x = NULL, y = "t95 [yr]") +
  theme_minimal() + theme(strip.placement = "outside")
```

# Appendix

## Integration of STP

$$\int STP = \delta \cdot e^2 \int \left(\left(\frac{x}{\tau}\right)^2 e^{-\frac{2}{\tau}x}\right) dx $$

IPP: we use \$u' = \frac{2x}{\tau^2}\$ and $v = -\frac{\tau}{2} \cdot e^{-\frac{2}{\tau}x}$

$$\int STP = \delta \cdot e^2 \left( uv - \int u'v \right) + C$$

$$\int STP = \delta \cdot e^2 \left( \left(\frac{x}{\tau}\right)^2\cdot(-\frac{\tau}{2} \cdot e^{-\frac{2}{\tau}x}) - \int \frac{2x}{\tau^2} (-\frac{\tau}{2} \cdot e^{-\frac{2}{\tau}x})dx \right) + C$$

$$\int STP = \delta \cdot e^2 \left( -\left(\frac{x^2}{2\tau}\right)   e^{-\frac{2}{\tau}x}+ \int \frac{x}{\tau} e^{-\frac{2}{\tau}x}dx \right) + C$$

Again, we use an IPP with \$u' = \frac{1}{\tau} \$ and $v = -\frac{\tau}{2} \cdot e^{-\frac{2}{\tau}x}$

$$\int STP = \delta \cdot e^2 \left( -\left(\frac{x^2}{2\tau}\right)   e^{-\frac{2}{\tau}x}+ \left( uv - \int u'v \right) \right) + C$$

$$\int STP = \delta \cdot e^2 \left( -\left(\frac{x^2}{2\tau}\right)   e^{-\frac{2}{\tau}x}+ \left( \frac{x}{\tau} (-\frac{\tau}{2} \cdot e^{-\frac{2}{\tau}x}) - \int \frac{1}{\tau} (-\frac{\tau}{2} \cdot e^{-\frac{2}{\tau}x}) \right) \right) + C$$

$$\int STP = \delta \cdot e^2 \left( -\left(\frac{x^2}{2\tau}\right)   e^{-\frac{2}{\tau}x}  -\frac{x}{2} \cdot e^{-\frac{2}{\tau}x} + \int  \frac{1}{2} \cdot e^{-\frac{2}{\tau}x}  \right) + C$$

$$\int STP = \delta \cdot e^2 \left( -\left(\frac{x^2}{2\tau}\right)   e^{-\frac{2}{\tau}x} -\frac{x}{2} \cdot e^{-\frac{2}{\tau}x} -\frac{\tau}{4} \cdot e^{-\frac{2}{\tau}x} \right) + C$$

$$\int STP = \delta \cdot e^{(1-\frac{x}{\tau})2} \left( -\frac{x^2}{2\tau}    -\frac{x}{2}  -\frac{\tau}{4}\right) + C$$

$$\int_0^t STP = \frac{\delta \cdot e^{2} \cdot\tau}{4} - \delta \cdot e^{(1-\frac{t}{\tau})2} \left(\frac{t^2}{2\tau}+\frac{t}{2}+\frac{\tau}{4}\right) $$

$$\int_0^t LTP = t - \frac{1}{\lambda} (1-e^{-\lambda\cdot t})$$

$$\int_0^t prod = \theta_0\cdot t + (\theta_{\infty} - \theta_0)\left(\frac{\delta \cdot e^{2} \cdot\tau}{4} - \delta \cdot e^{(1-\frac{t}{\tau})2} \left(\frac{t^2}{2\tau}+\frac{t}{2}+\frac{\tau}{4}\right) + t - \frac{1}{\lambda} (1-e^{-\lambda\cdot t})\right) $$

if $mort = \theta_{\infty}$:

$$\int_0^t mort = \theta_{\infty}\cdot t$$ then:

$$BA(t) = BA(0) + \theta_0\cdot t + (\theta_{\infty} - \theta_0)\left(\frac{\delta \cdot e^{2} \cdot\tau}{4} - \delta \cdot e^{(1-\frac{t}{\tau})2} \left(\frac{t^2}{2\tau}+\frac{t}{2}+\frac{\tau}{4}\right) + t - \frac{1}{\lambda} (1-e^{-\lambda\cdot t})\right)  - \theta_{\infty}\cdot t$$

$$BA(t) = BA(0) + (\theta_{\infty} - \theta_0)\left(\frac{\delta \cdot e^{2} \cdot\tau}{4} - \delta \cdot e^{(1-\frac{t}{\tau})2} \left(\frac{t^2}{2\tau}+\frac{t}{2}+\frac{\tau}{4}\right) + t - \frac{1}{\lambda} (1-e^{-\lambda\cdot t}) - t\right) $$

$$BA(t) = BA(0) + (\theta_{\infty} - \theta_0)\left(\frac{\delta \cdot e^{2} \cdot\tau}{4} - \delta \cdot e^{(1-\frac{t}{\tau})2} \left(\frac{t^2}{2\tau}+\frac{t}{2}+\frac{\tau}{4}\right) - \frac{1}{\lambda} (1-e^{-\lambda\cdot t})\right) $$

## Differential equation

We want to solve the following differential equation $E$:

$$ba'(t) = prod(t) - \omega \cdot ba(t)$$

with:

$$ prod(t) = \theta_0 + (\theta_{\infty} - \theta_0)\cdot\left(1 - exp(-\lambda\cdot t) + \delta\left(\frac{x}{\tau}\cdot exp(1-\frac{x}{\tau})\right)^2\right) $$

which we can write as:

$$ prod(t) = \theta_{\infty} + \alpha\cdot exp(-\lambda\cdot t) + \beta \left(\frac{x}{\tau}\cdot exp(1-\frac{x}{\tau})\right)^2$$

with: $\alpha = \theta_{0} - \theta_{\infty}$ and $\beta = (\theta_{\infty} - \theta_{0})\delta $

The general solution of differential equation $E_0$:

$$ba'(t) + \omega \cdot ba(t) = 0$$ 

is $y_G = Kexp(-\omega t)$

A particular solution of differential equation $E_1$:

$$ba'(t) + \omega \cdot ba(t) = \theta_{\infty} + \alpha\cdot exp(-\lambda\cdot t)$$

is 

$$y_{p1} = \frac{\theta_{\infty}}{\omega} + \frac{\alpha \lambda}{\omega\lambda - 1} \cdot exp(-\lambda\cdot t)$$

A particular solution of differential equation $E_2$:

$$ba'(t) + \omega \cdot ba(t) = \beta \left(\frac{t}{\tau}exp(1-\frac{t}{\tau})\right)^2$$

is 

$$y_{p2} = exp(1-\frac{t}{\tau})^2\frac{2\beta}{\tau^2(2\omega-\tau)}\left(t^2 - t\frac{4}{(2\omega-\tau)} + \frac{8}{(2\omega-\tau)^2}\right)$$

The general solution to differential equation (E) is therefore: 

$$y(t) = \frac{\theta_{\infty}}{\omega} + Kexp(-\omega t) + \frac{\alpha \lambda}{\omega\lambda - 1} \cdot exp(-\lambda\cdot t) + exp(1-\frac{t}{\tau})^2\frac{2\beta}{\tau^2(2\omega-\tau)}\left(t^2 - t\frac{4}{(2\omega-\tau)} + \frac{8}{(2\omega-\tau)^2}\right)$$
with $y(0) = BA_0$

$$ K = BA_0 - \frac{\theta_{\infty}}{\omega} - \frac{\alpha \lambda}{\omega\lambda - 1} -\frac{16e^2\beta}{\tau^2(2\omega-\tau)^3}$$



